# 仕様

## 認証情報

.env.example

```
ID=202602
PASSWORD=hoge
```

## CSV

次のヘッダーからなる。

```
q_num,q_num_sub,question,answer,explain
```

- `q_num`: 問題番号
- `q_num_sub`: 小問番号で、まれに1つの `q_num` の中に複数の小問が含まれるため
- `question`: 問い
- `answer`: 答え true（問題があっている ○） / false（問題が間違っている ×）
- `explain`: 答えの解説

`q_num` と `q_num_sub` を合わせればユニークになる。
小問が複数ない場合は `q_num_sub` は空になる。
`question` は小問1つにつき1問である。

この CSV ファイルは実行時引数で指定された値（`workbook`）のディレクトリ配下に保存する。
例えば、`workbook` が 7 であれば、`log/7/workbook.csv` となる。

---

# 実装手順

## 1. ログイン

https://www.musasi.jp/oomachi-nabeshima/login
にアクセスする

`id="username"` 属性を持つ input 要素に .env の ID の値を入力する

同様に、`id="password"` を持つ input 要素に PASSWORD の値を入力する

唯一 `name="Signin"` 属性を持つinput 要素をクリックする

```
document.querySelector('[name="hoge"]')?.click();
```

ログインが成功すれば、
https://www.musasi.jp/menu
に遷移する。

失敗していれば、URL は変わらず /login に遷移する。
（ページ再読込の挙動になる）
ただし、このとき

```
<div id="registrationErrors">
```

要素が追加される。

## 2. メニュー選択と初期化

id がないボタンが複数あるため、ボタン押下ではなく直接次にアクセスする。

https://www.musasi.jp/workbook/1/resume/revoke?delete=1

ローカルストレージに認証情報があるので、遷移してもセッションは途切れない。
また、この URL は前回記録の初期化も含んでいる。

## 3. 問題選択と解答準備

同様に問題に直接アクセスする。
対象となる問題の URL は次で全てである。

- https://www.musasi.jp/workbook/1/10951/7/manual
- https://www.musasi.jp/workbook/1/10951/8/manual
- https://www.musasi.jp/workbook/1/10951/9/manual
- https://www.musasi.jp/workbook/1/10951/10/manual
- https://www.musasi.jp/workbook/1/10951/11/manual
- https://www.musasi.jp/workbook/1/10951/12/manual

どの URL かは、実行時引数で指定するため次となる。

```
https://www.musasi.jp/workbook/1/10951/[workbook]/manual
```

その後、いずれかの URL にアクセスした後のページで、
唯一 `clss="btn_start"` 属性を持つ input 要素をクリックする。

```
document.querySelector('.btn_start')?.click();
```

すると、自動で次 URL に遷移する。

https://www.musasi.jp/question/1#disabledHistoryback

ここまでで解答可能な状態になった（解答準備完了）。

## 4. 問題の取得

まず、取得したデータを保存するCSV が `q_num,q_num_sub,question,answer,explain`
というヘッダーなので問題番号 `q_num` を記録する。
これは基本 1 から始まる自然数を記録すれば良いが、重複を認める。
これは、ある `q_num` （問題番号）1つに複数の
`q_num_sub` （小問番号）を持つ問題が含まれる場合があるためである。
小問が複数なければ空のフィールドになる。

その後、次 URL にアクセスする。

```
https://www.musasi.jp/question/explanation/[q_num]#disabledHistoryback
```

例えば、初めて実行するときは `q_num` は 1 始まりなので、
https://www.musasi.jp/question/explanation/1#disabledHistoryback
となる。

### `sub_id`

`sub_id` は基本、空である。

### `qestion`

次の XPath のテキストノードを取得する。

```
//*[@id="questionContainer"]/div/div[1]/div/p[1]
```

あるいは XPath ではなく DOM 操作で行う場合も述べる。
`id="questions"` 属性を持つ div 要素の子要素の中で、
唯一 `class="noBoth"` 属性を持つ最初の要素なので次でも良い。

```
document.querySelector('#questions .noBoth').textContent;
```

この取得したテキストに含まれる全ての改行、空白は空文字列で置換し、
`question` フィールドに記載する。

### `answer`

まず、`id="answer"` 属性を持つ div 要素の子要素の中で、
唯一の img タグの src 属性値を取得する。

```
document.querySelector('#answer img')?.src
```

取得した .png の URI に true が含まれていたら、`answer` フィールドも true と記載する。
取得した .png の URI に false が含まれていたら、`answer` フィールドも false と記載する。
それ以外であれば、フィールドは空とする。

### `explain`

`question` と同じ様に処理する。
次の XPath のテキストノードを取得する。

```
//*[@id="explanationContainer"]/div/div[1]/div/p[1]
```

あるいは XPath ではなく DOM 操作で行う場合も述べる。
`id="explain""` 属性を持つ div 要素の子要素の中で、
唯一 `class="noBoth"` 属性を持つ最初の要素なので次でも良い。

```
document.querySelector('#explain .noBoth').textContent;
```

この取得したテキストに含まれる全ての改行、空白は空文字列で置換し、
`explain` フィールドに記載する。

## 5. 次の問題に移る

`q_num` を 1 つインクリメントする。

次に、後述の 問題が存在しない場合 ではないか判定し、
問題が存在すれば 4. 問題の取得 の手順に戻る。
問題が存在しない場合 であるならば、繰り返さずに次の手順 5. に進む。

### 問題が存在しない場合

もし、次の問題 URL にアクセスしたとき HTTP Status Code 302 が返ってきて、
https://www.musasi.jp/menu にリダイレクト遷移した場合は
その問題 URL が存在しないことを意味する。

問題が存在する場合は HTTP Status Code 200 が返ってきて、
指定した問題 URL にアクセスできる。

---

# 手順調査時のログ

前述の手順は以下のなくても良い手順を省略している。
つまり、以下は知らなくて実装できる情報である。

## 前回記録の破棄

メニュー選択後、次に遷移されることがある。
https://www.musasi.jp/workbook/resume/confirm/224132674
これは、前回記録が残っているため破棄するかの確認である。
正常終了（記録を残さない終了）が実装されていないため、破棄を選ぶ。

結果的に https://www.musasi.jp/workbook/1/resume/revoke?delete=1 に遷移する。

## 問題取得と結果送信

次に現在のページに `id="subQuestion"` 属性を持つ div 要素がある場合は、
CSV のこの問題の行 question 列に、複数問題のためスキップ と記載し、
次の問題に移る（後述）。
もし subQuestion が無い場合は以下の処理を行う。

唯一 `class="noBoth"` 属性を持つ p 要素のテキストノードを取得する。
テキストに含まれる全ての改行は空文字列で置換する。
その置換後の文字列をCSV のこの問題の行 question 列に保存する。
このとき、この行の（この question に対応する） answer 列は true とする。

## 次の問題に移る処理

`id="answerItems"` 属性を持つ div 要素の子要素は 2 つの a 要素があるが、
その最初の a 要素である 唯一 `class="btn_true"` 属性を持つ a 要素をクリックする。

加えて `id="answer_0"` 属性を持つ input 要素もクリックする。
その後、`id="btn_nextQuestion_single"` 属性 または
`id="btn_nextQuestion"` を持つ li 要素をクリックし、次の問題に遷移する。
例えば、次が1問目を解いていたらなら次は2問目の
https://www.musasi.jp/question/2#disabledHistoryback
に遷移する。

2つの id の違いは、1問目は 前の問題に戻るボタンが無いため
`_single` がついた id で表示し UI を調節している。
2つの id どちらもない場合は最後の問題なので解答終了をする。

## 解答終了

`id="headerBtn_finish"` 属性を持つ li 要素をクリックする。
ポップアップを処理する。
結果的に https://www.musasi.jp/result に遷移する。
